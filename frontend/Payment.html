<!DOCTYPE html>
<html lang="en">
<head>

    <title>Altius Academy | Student Payment</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Icons -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Layout & Style -->
    <link rel="stylesheet" href="layout.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>

<!-- ================= TOP BAR ================= -->
<header class="topbar">
    <div class="top-left">
        <button class="menu-btn" onclick="toggleSidebar()">☰</button>
        <a href="StaffHomepage.html" class="top-logo">
            <img src="images/logo1.png">
            <span>Altius Academy</span>
        </a>
    </div>

    <div class="top-right">
        <div class="user-btn" onclick="toggleUserMenu()">Staff ▾</div>
        <div class="user-dropdown" id="userDropdown">
            <a href="StaffHomepage.html">My Profile</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </div>
</header>

<div class="layout">

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar" id="sidebar">
    <nav class="menu">
        <a href="TeacherList.html"><i class="fa-solid fa-chalkboard-user"></i><span>Teacher</span></a>
        <a href="StudentList.html" class="active"><i class="fa-solid fa-user-graduate"></i><span>Student</span></a>
        <a href="ClassList.html"><i class="fa-solid fa-school"></i><span>Class</span></a>
        <a href="EnrollmentList.html"><i class="fa-solid fa-file-signature"></i><span>Enrollment</span></a>
        <a href="PackageList.html"><i class="fa-solid fa-box"></i><span>Package</span></a>
        <a href="SubjectList.html"><i class="fa-solid fa-book"></i><span>Subject</span></a>
        <a href="AttendanceList.html"><i class="fa-solid fa-calendar-check"></i><span>Attendance</span></a>
        <a href="Report.html"><i class="fa-solid fa-chart-line"></i><span>Report</span></a>
    </nav>
</aside>

<!-- ================= MAIN ================= -->
<main class="main">

<h1 class="page-header">Student Payment Details</h1>

<!-- ================= SUMMARY ================= -->
<section class="summary-card">
    <div class="summary-item">
        <span class="label">Student Name</span>
        <span class="value" id="studentName">-</span>
    </div>

    <div class="summary-item">
        <span class="label">Student ID</span>
        <span class="value" id="studentId">-</span>
    </div>

    <div class="summary-item highlight">
        <span class="label">Total Paid (RM)</span>
        <span class="value" id="totalFee">0.00</span>
    </div>

    <div class="summary-item highlight">
        <span class="label">Outstanding Fees (RM)</span>
        <span class="value outstanding-text" id="outstandingFee">0.00</span>
    </div>
</section>

<!-- ================= TABLE ================= -->
<section class="table-section">
    <h2>Enrollments & Payments</h2>

    <table class="payment-table">
        <thead>
        <tr>
            <th>Enrollment ID</th>
            <th>Package</th>
            <th>Fee (RM)</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="EnrollmentTable"></tbody>
    </table>

    <p id="emptyMessage" class="empty-message" hidden>
        No enrollments found for this student.
    </p>
</section>



 </section>

  <!-- ================= ADD PAYMENT ================= -->
  <section class="add-payment-card">
    <h2>Add Payment</h2>

    <div class="payment-form">
      <div class="form-row">
        <label>Payment Date</label>
        <input type="date" id="paymentDate">
      </div>

      <div class="form-row">
        <label>Add Amount (RM)</label>
        <input type="number" id="paymentAmount" step="0.01">
      </div>

      <div class="payment-actions">
        <button class="button" onclick="submitPayment()">Save</button>
        <button class="button secondary" onclick="cancelPayment()">Cancel</button>
      </div>
    </div>
  </div>
  </section>

  </main>
</div>
<!-- ================= SCRIPT ================= -->
<script>
/* ===== UI ===== */
function toggleSidebar(){ sidebar.classList.toggle("collapsed"); }
function toggleUserMenu(){
    userDropdown.style.display =
        userDropdown.style.display === "block" ? "none" : "block";
}
function logout(){
    localStorage.removeItem("staff");
    location.href = "login.html";
}

/* ===== DATA ===== */
const studentId = new URLSearchParams(location.search).get("studentId");
let currentEnrollmentId = null;
let paidEnrollmentSet = new Set();

/* ===== LOAD DATA ===== */
async function loadStudentData(){
    try{
        const summaryRes = await fetch(
            `http://localhost:3000/payment/student-payment-summary?studentId=${studentId}`
        );
        const summary = await summaryRes.json();

        studentName.textContent = summary.STUDENTNAME || "-";
        document.getElementById("studentId").textContent = studentId;
        totalFee.textContent = parseFloat(summary.TOTALPAID || 0).toFixed(2);

        const enrollRes = await fetch(
            `http://localhost:3000/payment/enrollments?studentId=${studentId}`
        );
        const packages = await enrollRes.json();

        EnrollmentTable.innerHTML = "";
        paidEnrollmentSet.clear();

        let outstanding = 0;
        let rows = [];

        packages.forEach(pkg=>{
            if(pkg.PAID_ENROLLMENT_IDS){
                pkg.PAID_ENROLLMENT_IDS.split(", ")
                    .forEach(id=>paidEnrollmentSet.add(id));
            }

            pkg.ENROLLMENT_IDS.split(", ").forEach(id=>{
                const isPaid = paidEnrollmentSet.has(id);
                if(!isPaid) outstanding += parseFloat(pkg.PACKAGE_FEE);

                rows.push({
                    id,
                    name: pkg.PACKAGE_NAME,
                    fee: pkg.PACKAGE_FEE,
                    paid: isPaid
                });
            });
        });

        rows.sort((a,b)=>a.id-b.id);

        rows.forEach(r=>{
            EnrollmentTable.innerHTML += `
            <tr>
                <td>${r.id}</td>
                <td>${r.name}</td>
                <td>${parseFloat(r.fee).toFixed(2)}</td>
                <td>
                    <span class="status-badge ${r.paid?'paid':'unpaid'}">
                        ${r.paid?'Paid':'Unpaid'}
                    </span>
                </td>
                <td>
                    <button class="button ${r.paid?'disabled-btn':''}"
                        ${r.paid?'disabled':''}
                        onclick="openPaymentModal('${r.id}',${r.fee})">
                        Add Payment
                    </button>
                    <button class="button secondary ${!r.paid?'disabled-btn':''}"
                        ${!r.paid?'disabled':''}
                        onclick="viewReceipt('${r.id}')">
                        View Receipt
                    </button>
                </td>
            </tr>`;
        });

        outstandingFee.textContent = outstanding.toFixed(2);

    }catch(e){
        alert("Failed to load payment data");
        console.error(e);
    }
}

/* ===== MODAL ===== */
function openPaymentModal(id,fee){
    currentEnrollmentId = id;
    paymentAmount.value = parseFloat(fee).toFixed(2);
    paymentDate.valueAsDate = new Date();
    paymentModal.classList.remove("hidden");
}
function closePaymentModal(){
    paymentModal.classList.add("hidden");
    currentEnrollmentId = null;
}

/* ===== PAYMENT ===== */
async function submitPayment(){
    if(!currentEnrollmentId) return;

    await fetch("http://localhost:3000/payment",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            enrollmentId:currentEnrollmentId,
            paymentDate:paymentDate.value,
            totalFees:paymentAmount.value
        })
    });

    alert("Payment added successfully");
    closePaymentModal();
    loadStudentData();
}

function viewReceipt(id){
    location.href = `Receipt.html?enrollId=${id}`;
}

/* ===== INIT ===== */
document.addEventListener("DOMContentLoaded", loadStudentData);
</script>

</body>
</html>
